CREATE DATABASE db_biblioteca
GO

USE db_biblioteca
GO

CREATE TABLE TIPOS_USUARIO(
	ID_TIPO INT IDENTITY(1,1) PRIMARY KEY,
	TIPO VARCHAR(50) UNIQUE NOT NULL
);


CREATE TABLE STATUS_USUARIO( --
	ID_STATUS INT IDENTITY(1,1) PRIMARY KEY,
	STATUS VARCHAR(30) UNIQUE NOT NULL
);


CREATE TABLE GENEROS( --
	ID_GENERO INT IDENTITY(1,1) PRIMARY KEY,
	GENERO VARCHAR(50) UNIQUE NOT NULL
);


CREATE TABLE AUTORES( --
	ID_AUTOR INT IDENTITY(1,1) PRIMARY KEY,
	AUTOR VARCHAR(50) UNIQUE NOT NULL
);


CREATE TABLE ESTADO_EXEMPLARES( --
	ID_ESTADO INT IDENTITY(1,1) PRIMARY KEY,
	ESTADO VARCHAR(50) UNIQUE NOT NULL
);


CREATE TABLE STATUS_EMPRESTIMO( --
	ID_STATUS INT IDENTITY(1,1) PRIMARY KEY,
	STATUS VARCHAR(50) UNIQUE NOT NULL
);

CREATE TABLE TIPOS_REQUISICAO( --
	ID_TIPO INT IDENTITY(1,1) PRIMARY KEY, 
	REQUISICAO VARCHAR(50) UNIQUE NOT NULL
) 


CREATE TABLE PERFIS( --
	ID_PERFIL INT IDENTITY(1,1) PRIMARY KEY,
	NOME NVARCHAR(30) NOT NULL,
	SOBRENOME NVARCHAR(50) NOT NULL,
	DATA_NASCIMENTO DATE NOT NULL,
	EMAIL NVARCHAR(255) NOT NULL UNIQUE,
	COD_PERFIL NCHAR(7) NOT NULL UNIQUE,
	CPF VARCHAR(14) UNIQUE NOT NULL,
	TIPO_USUARIO INT,
	TELEFONE VARCHAR(13) UNIQUE NOT NULL,
	STATUS INT,
	
	FOREIGN KEY (TIPO_USUARIO) REFERENCES TIPOS_USUARIO(ID_TIPO) ON DELETE SET NULL,
	FOREIGN KEY (STATUS) REFERENCES STATUS_USUARIO(ID_STATUS) ON DELETE SET NULL
);


CREATE TABLE LOGIN_USUARIOS( --
	ID_LOGIN INT IDENTITY(1,1) PRIMARY KEY,
	SENHA VARBINARY(64) NOT NULL,
	ID_PERFIL INT UNIQUE NOT NULL,
	SALT UNIQUEIDENTIFIER NOT NULL,

	FOREIGN KEY (ID_PERFIL) REFERENCES PERFIS(ID_PERFIL) ON DELETE CASCADE
);


CREATE TABLE LIVROS( --
	ID_LIVRO INT IDENTITY(1,1) PRIMARY KEY,
	NOME NVARCHAR(50) NOT NULL,
	COD_LIVRO NCHAR(7) NOT NULL,
	ID_GENERO INT,
	EDICAO SMALLINT NOT NULL,
	DATA_PUBLICACAO DATE,
	ID_AUTOR INT,
	
	FOREIGN KEY (ID_GENERO) REFERENCES GENEROS(ID_GENERO) ON DELETE SET NULL,
	FOREIGN KEY (ID_AUTOR) REFERENCES AUTORES(ID_AUTOR) ON DELETE SET NULL
);


CREATE TABLE LOGS_ACESSO( --
	ID_LOG INT IDENTITY(1,1) PRIMARY KEY,
	ACAO NVARCHAR(40) NOT NULL,
	ID_PERFIL INT NOT NULL,
	TABELA_AFETADA NVARCHAR(50) DEFAULT 'SEM ALTERACAO' NOT NULL,
	DESCRICAO NVARCHAR(255) NOT NULL,
	ID_ALTERADO VARCHAR(500) DEFAULT 'SEM ALTERACAO' NOT NULL,
	DATA_REALIZADO DATE DEFAULT CAST(GETDATE() AS DATE),
	HORA_REALIZADO TIME DEFAULT CAST(GETDATE() AS TIME),
);


CREATE TABLE EXEMPLARES( --
	ID_EXEMPLAR INT IDENTITY(1,1) PRIMARY KEY,
	ID_LIVRO INT,
	COD_EXEMPLAR NCHAR(7) NOT NULL,
	ID_ESTADO INT,
	
	FOREIGN KEY (ID_LIVRO) REFERENCES LIVROS(ID_LIVRO) ON DELETE CASCADE,
	FOREIGN KEY (ID_ESTADO) REFERENCES ESTADO_EXEMPLARES(ID_ESTADO) ON DELETE SET NULL
);


CREATE TABLE EMPRESTIMOS( --
	ID_EMPRESTIMO INT IDENTITY(1,1) PRIMARY KEY,
	COD_EMPRESTIMO CHAR(7) NOT NULL,
	DATA_REGISTRO DATE NOT NULL,
	DATA_DEVOLVER DATE NOT NULL,
	DATA_ENTREGUE DATE,
	ID_PERFIL INT NOT NULL,
	ID_EXEMPLAR INT UNIQUE NOT NULL,
	ID_STATUS INT,
	
	FOREIGN KEY (ID_PERFIL) REFERENCES PERFIS(ID_PERFIL) ON DELETE CASCADE,
	FOREIGN KEY (ID_EXEMPLAR) REFERENCES EXEMPLARES(ID_EXEMPLAR) ON DELETE CASCADE,
	FOREIGN KEY (ID_STATUS) REFERENCES STATUS_EMPRESTIMO(ID_STATUS) ON DELETE SET NULL
);


CREATE TABLE REQUISICOES( --
	ID_REQUISICAO INT IDENTITY (1,1) PRIMARY KEY, 
	DATAHORA_REQUISICAO DATETIME2 NOT NULL, 
	ID_LIVRO INT, 
	ID_PERFIL INT, 
	COD_DEVOLVER CHAR (7) NOT NULL, 
	TIPO_REQUISICAO VARCHAR (50) NOT NULL, 
 
	FOREIGN KEY (ID_LIVRO) REFERENCES LIVROS(ID_LIVRO) ON DELETE SET NULL, 
	FOREIGN KEY (ID_PERFIL) REFERENCES PERFIS(ID_PERFIL) ON DELETE CASCADE 
) 
